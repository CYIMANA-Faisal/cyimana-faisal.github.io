<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit article</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/sytles.css">
    <link rel="stylesheet" href="../css/create-article.css">
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="container flex">
            <h1 class="logo">Builder</h1>
            <i class="fas fa-bars fa-2x bugger"></i>
            <nav class="navigation hide">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="blog.html">Profile</a></li>
                    <li><a href="blog.html">Sign out</a></li>
                </ul>
            </nav>
        </div>
    </div>
    <div class="create-article">
        <div class="container form-holder">
            <form class="update-form" method="POST">
                <input type="text" placeholder="Article title" class="title" value="" name="title"><br>
                <Span>Change the thumbnail image </Span><input  type="file" name="image" class="img"><br>
                Type content of your article <br>
                <textarea name="content" class="content">
                    
                </textarea><br>
                <button class="btn">Update</button>
            </form>
        </div>
    </div>
    <script src="../js/main.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyD0Fq-6U89Mjc8_t8hnAvN8UseYP36M0s8",
            authDomain: "portfolio-web-f7399.firebaseapp.com",
            databaseURL: "https://portfolio-web-f7399.firebaseio.com",
            projectId: "portfolio-web-f7399",
            storageBucket: "portfolio-web-f7399.appspot.com",
            messagingSenderId: "492367414075",
            appId: "1:492367414075:web:0d399f48ec7c26fad6ad1e",
            measurementId: "G-SJ9NLBC3QC"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({timestampsInSnapshots: true});


        const id = location.hash.slice(1);
        let imagePath = '';
        const renderUpdate = function (article) {
            const title = document.querySelector('.title');
            const content = document.querySelector('.content');
            title.value = article.title;
            content.textContent = article.content;
            imagePath = article.image;
        };
        
        const getArticle = function (id) {
            var docRef = db.collection("articles").doc(id);

            docRef.get().then(function(doc) {
                if (doc.exists) {
                    renderUpdate(doc.data());
                } else {   
                    alert("No such document in the collection!");
                }
            })
            .catch(function(error) {
                alert("Error getting document: " + error);
            });
        };

        getArticle(id);

        document.querySelector('.update-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = e.target.elements.title.value;
            const image = e.target.elements.image.files;
            const content = e.target.elements.content.value;
            
            if(image.length === 0){
                const data = {
                    title: title,
                    content: content
                };
                db.collection("articles").doc(id).update(data).then(() => {
                    alert("Article updated successfully but the image is not");
                    location.assign(`article.html#${id}`);
                })
                .catch((error) => {
                    alert(`Update error: ${error}`);
                });
            }//END OF IF STATEMENT
            if (image.length === 1) {
                // DELETING THE FILE
                let httpsReference = firebase.storage().refFromURL(imagePath);
                httpsReference.delete().then(function() {
                    var storageRef = firebase.storage().ref().child(`articles/${image[0].name}`);
                            // UPLOADING NEW IMAGE 
                            storageRef.put(image[0]).then(function() {
                                // GETTING IT URL AFTER UPLOADING IT.
                                storageRef.getDownloadURL().then(url => {
                                    const newPath = url;
                                    // UPDATING ARTICLE IN FIRESTORE
                                    const data = {
                                        title: title,
                                        image: newPath,
                                        content: content
                                    };
                                    db.collection("articles").doc(id).update(data).then(() => {
                                        alert("Article updated successfully and the new image");
                                        location.assign(`article.html#${id}`);
                                    })
                                    .catch((error) => {
                                        alert(`Update error: ${error}`);
                                    });

                                })
                                .catch(error => {
                                    alert('Failed to get the URL');
                                });

                            })
                            .catch(function (error) {
                                alert("Failed to download image URL to be stored in firestore");
                            });
                })
                .catch(function(error) {
                    switch (error.code) {
                        case 'storage/object-not-found':
                            var storageRef = firebase.storage().ref().child(`articles/${image[0].name}`);
                            // UPLOADING NEW IMAGE 
                            storageRef.put(image[0]).then(function() {
                                // GETTING IT URL AFTER UPLOADING IT.
                                storageRef.getDownloadURL().then(url => {
                                    const newPath = url;
                                    // UPDATING ARTICLE IN FIRESTORE
                                    const data = {
                                        title: title,
                                        image: newPath,
                                        content: content
                                    };
                                    db.collection("articles").doc(id).update(data).then(() => {
                                        alert("Article updated successfully and the new image");
                                        location.assign(`article.html#${id}`);
                                    })
                                    .catch((error) => {
                                        alert(`Update error: ${error}`);
                                    });
                                })
                                .catch(error => {
                                    alert('Failed to get the URL');
                                });
                            })
                            .catch(function (error) {
                                alert("Failed to download image URL to be stored in firestore");
                            });
                        break;
                    }
                });

            }//END IF THE IF STATEMENT
        });
    </script>
</body>
</html>