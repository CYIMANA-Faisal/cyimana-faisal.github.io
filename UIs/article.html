<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/sytles.css">
    <link rel="stylesheet" href="../css/article.css">
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="container flex">
            <h1 class="logo">Builder</h1>
            <i class="fas fa-bars fa-3x bugger"></i>
            <nav class="navigation hide">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="signin.html">Sign in</a></li>
                </ul>
            </nav>
        </div>
    </div> 
    

    <!-- Article -->
    <div class="article">
        <div class="container article-grid">
            <h1 id="title"></h1>
            <hr>
            <img src="" alt="" id="article-image">
            <p id="article-content">
                
            </p>
            <hr>
            <div class="author">
                <img src="../images/profiles/avatar.png" alt="">
                <span>CYIMANA Faisal <br> <i class="timestamp"> 2 days ago</i></span>
            </div>
            <hr>
            <div class="add-comment">
                <h4>Add comment</h4>
                <form method="POST" class="comment-form">
                    <input type="text" placeholder="Your name" name="name"><br>
                    your comment: <br>
                    <textarea name="comment">

                    </textarea><br>
                    <button class="btn">Comment</button>
                </form>
            </div>
            <hr>
            <h3>Comments</h3>
            <div class="comment-wraper">

            </div>
        </div>
    </div>

    <footer >
        <div class="container grid-1">
            <h3 class="text-center">Created and Developed by CYIMANA Faisal</h3>
            <div class="social .flex">
                <a href=""> <i class="fab fa-twitter fa-2x"></i></a>
                <a href=""> <i class="fab fa-github fa-2x"></i></a>
                <a href=""> <i class="fab fa-instagram fa-2x"></i></a>
                <a href=""> <i class="fab fa-linkedin fa-2x"></i></a>
                <a href=""> <i class="fab fa-facebook fa-2x"></i></a>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyD0Fq-6U89Mjc8_t8hnAvN8UseYP36M0s8",
            authDomain: "portfolio-web-f7399.firebaseapp.com",
            databaseURL: "https://portfolio-web-f7399.firebaseio.com",
            projectId: "portfolio-web-f7399",
            storageBucket: "portfolio-web-f7399.appspot.com",
            messagingSenderId: "492367414075",
            appId: "1:492367414075:web:0d399f48ec7c26fad6ad1e",
            measurementId: "G-SJ9NLBC3QC"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({timestampsInSnapshots: true});
    </script>
    <script src="../js/articles-functions.js"></script>
    <script src="../js/main.js"></script>
    <script>
        const id = location.hash.slice(1);
        getArticle(id);
        const renderComments = function (id) {
            db.collection('comments').orderBy("timestamp", 'desc').where('articleID', '==', id).get().then( (snapshot) => {
                snapshot.forEach((doc) => {
                    
                    // RENDER STARTS FROM HERE
                    const container = document.querySelector('.comment-wraper');
                    const commentDiv = document.createElement('div');
                    commentDiv.setAttribute('class', 'comment');
                    const commentor = document.createElement('div');
                    commentor.setAttribute('class', 'commentor');
                    const avatar = document.createElement('img');
                    avatar.setAttribute('src', '../images/profiles/avatar.png');
                    const span = document.createElement('span')
                    span.textContent = doc.data().name;
                    const br = document.createElement('br');
                    const time = document.createElement('i');
                    time.textContent = moment(doc.data().timestamp).fromNow();
                    const content = document.createElement('p');
                    content.textContent = doc.data().comment;

                    span.appendChild(br);
                    span.appendChild(time);
                    commentor.appendChild(avatar);
                    commentor.appendChild(span);
                    commentDiv.appendChild(commentor);
                    commentDiv.appendChild(content);
                    
                    container.appendChild(commentDiv);
                });
            }).catch( error => {
                console.log(`opps an error: ${error}` );
            })
        }
        renderComments(id);
        // CREATE COMMENT
        const commentForm = document.querySelector('.comment-form');
        commentForm.addEventListener('submit', e => {
            e.preventDefault();
            const articleID = id;
            const name = e.target.elements.name.value;
            const comment = e.target.elements.comment.value;
            const timestamp = Date.parse(new Date());

            const data = {
                articleID, 
                name,
                comment,
                timestamp
            };
            e.target.elements.name.value = '';
            e.target.elements.comment.value = '';

            db.collection('comments').doc(uuidv4()).set(data).then( () => {
                document.querySelector('.comment-wraper').innerHTML = '';
                renderComments(id);
            }).catch(error => {
                alert(`Ooops the error: ${error}`);
            });
        });
    </script>
</body>
</html>